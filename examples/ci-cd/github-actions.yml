name: Stellar Contract CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  STELLAR_NETWORK: testnet
  NOTIFICATION_WEBHOOK: ${{ secrets.NOTIFICATION_WEBHOOK }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ¦€ Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
      
      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: ğŸ”¨ Build contract
        run: |
          cargo build --release --target wasm32-unknown-unknown
          echo "âœ… Build complete"
      
      - name: ğŸ§ª Run tests
        run: |
          cargo test
          echo "âœ… Tests passed"
      
      - name: ğŸ“Š Generate stats
        run: |
          stellar stats > stats.txt || echo "Stats unavailable"
          cat stats.txt
      
      - name: ğŸ”® Get fortune
        run: |
          stellar fortune -t blockchain
      
      - name: ğŸ“² Notify success
        if: success()
        run: |
          stellar notify send \
            -m "âœ… Build & tests passed on ${{ github.ref_name }}" \
            -t "CI Success" \
            -p normal

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ¦€ Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
      
      - name: ğŸ”¨ Build for deployment
        run: |
          cargo build --release --target wasm32-unknown-unknown
      
      - name: ğŸš€ Deploy to Stellar
        id: deploy
        run: |
          CONTRACT_ID=$(stellar contract deploy \
            --wasm target/wasm32-unknown-unknown/release/contract.wasm \
            --network $STELLAR_NETWORK \
            --source ${{ secrets.STELLAR_SECRET_KEY }} | \
            grep -o 'C[A-Z0-9]\{55\}' || echo "DEPLOY_FAILED")
          
          echo "contract_id=$CONTRACT_ID" >> $GITHUB_OUTPUT
          echo "âœ… Deployed: $CONTRACT_ID"
      
      - name: ğŸ“± Generate mobile QR
        if: success()
        run: |
          stellar sync qr-code -a ${{ steps.deploy.outputs.contract_id }}
      
      - name: ğŸ‰ Celebrate with meme
        if: success()
        run: |
          stellar meme -t moon
      
      - name: ğŸ“² Notify deployment success
        if: success()
        run: |
          stellar notify send \
            -m "ğŸš€ Deployed to $STELLAR_NETWORK! Contract: ${{ steps.deploy.outputs.contract_id }}" \
            -t "Deployment Success" \
            -p high \
            --tx-hash "${{ steps.deploy.outputs.contract_id }}"
      
      - name: ğŸ“² Notify deployment failure
        if: failure()
        run: |
          stellar notify send \
            -m "âŒ Deployment failed on ${{ github.ref_name }}" \
            -t "Deployment Failed" \
            -p urgent
          
          stellar meme -t rekt

  scheduled-backup:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ“¦ Backup Stellar data
        run: |
          stellar sync export -o ./stellar-backup
      
      - name: ğŸ’¾ Upload backup artifact
        uses: actions/upload-artifact@v3
        with:
          name: stellar-backup-${{ github.run_number }}
          path: ./stellar-backup
      
      - name: ğŸ“² Notify backup complete
        run: |
          stellar notify send \
            -m "ğŸ“¦ Scheduled backup complete" \
            -t "Backup Success" \
            -p normal

# Scheduled backup (daily at 2 AM UTC)
on:
  schedule:
    - cron: '0 2 * * *'
